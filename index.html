<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UV Running - Dashboard Oficial</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Archivo+Black&family=Inter:wght@400;600;700;900&display=swap');

        :root {
            --bg: #f0f4f8;
            --glass: rgba(255,255,255,0.7);
            --glass-border: rgba(255,255,255,0.9);
            --text: #0f172a;
            --muted: #64748b;
            --green: #10b981;
            --darkgreen: #059669;
            --blue: #3b82f6;
            --red: #ef4444;
            --yellow: #f59e0b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .font-sport {
            font-family: 'Archivo Black', sans-serif;
            text-transform: uppercase;
            letter-spacing: -0.02em;
        }

        .glass {
            background: var(--glass);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.07);
        }

        /* Sports background */
        .sports-bg { position: fixed; inset: 0; z-index: 0; pointer-events: none; overflow: hidden; }
        .sports-bg span {
            position: absolute; opacity: 0.06;
            animation: floatIcon 16s infinite ease-in-out;
            user-select: none; line-height: 1;
        }
        @keyframes floatIcon {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50%       { transform: translateY(-20px) rotate(12deg); }
        }

        .page { position: relative; z-index: 1; padding: 16px; max-width: 1100px; margin: 0 auto; }

        /* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
        #loginScreen { max-width: 420px; margin: 40px auto; text-align: center; }
        #loginScreen h1 { font-size: clamp(2.5rem, 8vw, 3.5rem); color: var(--darkgreen); font-style: italic; }
        #loginScreen p  { font-size: 9px; letter-spacing: 0.4em; color: var(--muted); text-transform: uppercase; margin: 6px 0 24px; }
        #userPicker { max-height: 60vh; overflow-y: auto; padding-right: 4px; }

        .user-btn {
            width: 100%; text-align: left; padding: 14px 18px;
            background: var(--glass); border: 1px solid var(--glass-border);
            border-radius: 14px; font-weight: 700; font-size: 0.9rem;
            color: var(--text); cursor: pointer; transition: all 0.2s;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px;
        }
        .user-btn:hover, .user-btn:active { background: rgba(16,185,129,0.12); border-color: var(--green); }

        /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
        .app-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px;
        }
        .app-header h2 { font-size: clamp(1.2rem, 5vw, 1.8rem); }
        .app-header p  { font-size: 10px; font-weight: 800; color: var(--green); text-transform: uppercase; letter-spacing: 0.12em; margin-top: 2px; }
        .btn-salir {
            background: var(--glass); border: 1px solid var(--glass-border);
            border-radius: 12px; padding: 8px 16px; font-size: 11px;
            font-weight: 800; text-transform: uppercase; color: var(--muted);
            cursor: pointer; white-space: nowrap;
        }

        /* ‚îÄ‚îÄ MAIN GRID ‚îÄ‚îÄ */
        .main-grid {
            display: grid;
            grid-template-columns: 340px 1fr;
            gap: 20px;
            align-items: start;
        }
        @media (max-width: 800px) {
            .main-grid { grid-template-columns: 1fr; }
        }

        .left-col { display: flex; flex-direction: column; gap: 16px; }

        /* Progress card */
        .card-progress { padding: 18px; border-top: 3px solid var(--blue); }
        .card-progress .dates {
            display: flex; justify-content: space-between;
            font-size: 10px; font-weight: 800; color: var(--muted); margin-bottom: 8px;
        }
        .progress-track { height: 10px; background: #e2e8f0; border-radius: 99px; overflow: hidden; }
        .progress-fill  { height: 100%; border-radius: 99px; background: linear-gradient(90deg, var(--blue), var(--green)); transition: width 1s; box-shadow: 0 0 12px rgba(16,185,129,0.3); }

        /* Pozo card */
        .card-pozo { padding: 24px; text-align: center; border-bottom: 4px solid var(--green); }
        .card-pozo .label { font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.15em; color: var(--muted); }
        .card-pozo .amount { font-size: clamp(2.2rem, 8vw, 3rem); color: var(--darkgreen); margin-top: 6px; }
        .pajero-box { margin-top: 14px; padding-top: 14px; border-top: 1px solid #e2e8f0; display: none; }
        .pajero-box .pajero-tag  { font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; color: var(--red); }
        .pajero-box .pajero-name { font-size: 1rem; font-weight: 900; color: var(--text); margin: 4px 0 2px; }
        .pajero-box .pajero-pct  { font-size: 11px; color: var(--muted); font-weight: 600; margin-bottom: 2px; }
        .pajero-box .pajero-txt  { font-size: 11px; color: var(--red); font-weight: 700; }

        /* Form card */
        .card-form { padding: 22px; border-left: 4px solid var(--green); }
        .card-form h3 { font-size: 1.1rem; font-weight: 800; color: var(--darkgreen); font-style: italic; margin-bottom: 18px; }
        .form-label { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); display: block; margin-bottom: 6px; }
        .form-group { margin-bottom: 14px; }

        select {
            width: 100%; background: rgba(255,255,255,0.9);
            color: var(--text); border: 1px solid #e2e8f0;
            border-radius: 12px; padding: 14px; font-family: 'Inter', sans-serif;
            font-size: 16px; outline: none; transition: border 0.2s;
            -webkit-appearance: none; appearance: none;
        }
        select:focus { border-color: var(--green); }

        /* +/- fallos */
        .fallos-control { display: flex; align-items: center; gap: 10px; }
        .fallos-btn {
            width: 56px; height: 56px; border-radius: 14px; border: none;
            font-size: 1.8rem; font-weight: 900; cursor: pointer;
            flex-shrink: 0; transition: transform 0.1s, background 0.15s;
            display: flex; align-items: center; justify-content: center;
        }
        .fallos-btn:active { transform: scale(0.92); }
        .fallos-btn.minus { background: #e2e8f0; color: var(--text); }
        .fallos-btn.plus  { background: var(--green); color: white; }
        .fallos-display {
            flex: 1; background: rgba(255,255,255,0.9); border: 1px solid #e2e8f0;
            border-radius: 12px; text-align: center; font-size: 2rem;
            font-weight: 900; padding: 10px; color: var(--text);
        }

        .multa-preview { font-size: 12px; color: var(--muted); text-align: center; margin: 10px 0 14px; }
        .multa-preview strong { color: var(--darkgreen); font-size: 1rem; }

        .btn-save {
            width: 100%; background: var(--green); color: white; border: none;
            border-radius: 14px; font-family: 'Archivo Black', sans-serif;
            font-size: 0.85rem; text-transform: uppercase; cursor: pointer;
            height: 54px; transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(16,185,129,0.3);
        }
        .btn-save:active   { transform: scale(0.97); }
        .btn-save:disabled { background: #94a3b8; box-shadow: none; cursor: not-allowed; }

        /* ‚îÄ‚îÄ RANKING ‚îÄ‚îÄ */
        .card-ranking { padding: 20px; }
        .ranking-header-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 16px; flex-wrap: wrap; gap: 8px;
        }
        .ranking-header-bar h3 { font-size: 0.75rem; color: var(--muted); }
        .legend { display: flex; gap: 12px; flex-wrap: wrap; }
        .legend span { display: flex; align-items: center; gap: 5px; font-size: 9px; font-weight: 800; text-transform: uppercase; color: var(--muted); }

        .week-dot { width: 11px; height: 11px; border-radius: 3px; flex-shrink: 0; }
        .dot-ok     { background: var(--green);  box-shadow: 0 0 6px rgba(16,185,129,0.5); }
        .dot-fallo  { background: var(--yellow); box-shadow: 0 0 6px rgba(245,158,11,0.5); }
        .dot-debe   { background: var(--red);    box-shadow: 0 0 6px rgba(239,68,68,0.4); }
        .dot-futuro { background: #cbd5e1; }

        /* Ranking table ‚Äî scrollable on mobile */
        .ranking-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .ranking-table  { min-width: 480px; width: 100%; }

        .ranking-col-header {
            display: grid;
            grid-template-columns: 28px 1fr 36px 135px 50px 70px;
            gap: 6px; align-items: center;
            padding: 0 10px 8px;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 6px;
            font-size: 8px; font-weight: 900; color: #94a3b8; text-transform: uppercase;
        }

        .rank-row {
            display: grid;
            grid-template-columns: 28px 1fr 36px 135px 50px 70px;
            gap: 6px; align-items: center;
            padding: 12px 10px;
            background: rgba(255,255,255,0.5);
            border: 1px solid rgba(255,255,255,0.8);
            border-radius: 12px;
            margin-bottom: 6px;
        }
        .rank-row.me { border-color: var(--green); background: rgba(16,185,129,0.07); }

        .rank-num  { font-size: 10px; font-weight: 900; color: #94a3b8; }
        .rank-name { font-size: 12px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .rank-meta { font-size: 11px; font-weight: 800; color: var(--blue); text-align: center; }
        .rank-dots { display: flex; gap: 4px; flex-wrap: nowrap; }
        .rank-fallos { font-size: 11px; font-weight: 800; text-align: center; }
        .rank-monto { font-family: 'Archivo Black', sans-serif; text-transform: uppercase; font-size: 11px; color: var(--darkgreen); text-align: right; }

        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 99px; }
    </style>
</head>
<body>

<div class="sports-bg" id="sportsBg"></div>

<div class="page">

    <!-- LOGIN -->
    <div id="loginScreen">
        <h1 class="font-sport">UV Running</h1>
        <p>Challenge 2026 ¬∑ Management System</p>
        <div class="glass" style="padding: 20px;">
            <p style="font-size:10px; font-weight:800; color:var(--muted); text-transform:uppercase; letter-spacing:0.15em; margin-bottom:12px;">¬øQui√©n eres?</p>
            <div id="userPicker"></div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" style="display:none;">

        <div class="app-header">
            <div>
                <h2 class="font-sport">Challenge 2026</h2>
                <p id="progressPercent"></p>
            </div>
            <button class="btn-salir" onclick="location.reload()">Salir</button>
        </div>

        <div class="main-grid">

            <!-- LEFT -->
            <div class="left-col">

                <div class="glass card-progress">
                    <div class="dates">
                        <span>12 ENE</span>
                        <span style="color:var(--blue); font-size:1.2em;">11 MAR üçñ</span>
                    </div>
                    <div class="progress-track">
                        <div id="progressBar" class="progress-fill" style="width:0%"></div>
                    </div>
                </div>

                <div class="glass card-pozo">
                    <div class="label">Pozo Total Acumulado</div>
                    <div id="totalPozo" class="font-sport amount">$0.00</div>
                    <div class="pajero-box" id="pajeroBox">
                        <div class="pajero-tag">üèÜ Mayor aportante</div>
                        <div class="pajero-name" id="pajeroNombre">‚Äî</div>
                        <div class="pajero-pct" id="pajeroPct"></div>
                        <div class="pajero-txt">¬°Eres un pajero! ü§£</div>
                    </div>
                </div>

                <div class="glass card-form">
                    <h3 id="userNameDisplay"></h3>

                    <div class="form-group">
                        <label class="form-label">Semana</label>
                        <select id="semanaSelector" onchange="cargarReporteSemanal()"></select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Fallos <span id="metaLabel" style="color:var(--green);"></span></label>
                        <div class="fallos-control">
                            <button class="fallos-btn minus" onclick="cambiarFallos(-0.5)">‚àí</button>
                            <div class="fallos-display" id="fallosDisplay">0</div>
                            <button class="fallos-btn plus"  onclick="cambiarFallos(0.5)">+</button>
                        </div>
                        <input type="hidden" id="inputFallos" value="0">
                    </div>

                    <div class="multa-preview">
                        Multa esta semana: <strong id="multaPreview">$0.00</strong>
                    </div>

                    <button id="btnGuardar" class="btn-save" onclick="enviarReporte()">GUARDAR</button>
                </div>

            </div>

            <!-- RIGHT: RANKING -->
            <div class="glass card-ranking">
                <div class="ranking-header-bar">
                    <h3 class="font-sport">Estado de Reportes</h3>
                    <div class="legend">
                        <span><div class="week-dot dot-ok"></div>OK</span>
                        <span><div class="week-dot dot-fallo"></div>Fall√≥</span>
                        <span><div class="week-dot dot-debe"></div>Sin registro</span>
                        <span><div class="week-dot dot-futuro"></div>Futuro</span>
                    </div>
                </div>
                <div class="ranking-scroll">
                    <div class="ranking-table">
                        <div class="ranking-col-header">
                            <div>#</div>
                            <div>Nombre</div>
                            <div style="text-align:center;">Meta</div>
                            <div id="semanasHeader" style="display:flex; gap:4px;"></div>
                            <div style="text-align:center;">Fallos</div>
                            <div style="text-align:right;">Multa</div>
                        </div>
                        <div id="rankingRows"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://yibllgoulqowzewyusdh.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlpYmxsZ291bHFvd3pld3l1c2RoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzODAxODksImV4cCI6MjA4Njk1NjE4OX0.JcDzcK_xDIBaXI_sZQGGvEl9-2x4BeuDMZQRV2DJWUs';
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const participantes = {
        "Mati Adauy": 7, "Pablo Torn√©": 6, "Joaqu√≠n Leonart": 5,
        "Sami Arteaga": 5, "Pedro De la Barra": 5, "Seba √Åbalos": 5,
        "Tom√°s Balbont√≠n": 4, "Roque Santa Cruz": 4, "Rodrigo √Åbalos": 4,
        "Le√≥n Lehman": 4, "Eugenio Cox": 4, "Fe√±a Covarrubias": 4, "JT √Åbalos": 4,
        "Seba Domeyko": 3, "Lucas Perez": 3, "Mart√≠n Gonz√°lez": 3,
        "Mart√≠n Mu√±oz": 3, "Ignacio Eyzaguirre": 3, "Pablo Bas": 3,
        "Nacho Achondo": 3, "Tat√°n Ruiz": 3, "Toto Lab√°n": 3
    };

    const semanas = [];
    { let d = new Date(2026,0,12);
      for(let i=0;i<9;i++){ let s=new Date(d); semanas.push({id:`sem-${s.getDate()}-${s.getMonth()+1}`,label:`S${i+1}`,inicio:s}); d.setDate(d.getDate()+7); } }

    let currentUser = "";
    let currentFallos = 0;

    function buildBg() {
        const icons = ['‚öΩ','üéæ','üèÉ','üèä','üö¥','üèãÔ∏è','ü•ä','üèÖ','üéΩ','üèÜ','ü§∏','‚õπÔ∏è','üèåÔ∏è','üßó'];
        const bg = document.getElementById('sportsBg');
        for(let i=0;i<28;i++){
            const s = document.createElement('span');
            s.textContent = icons[i%icons.length];
            s.style.left = (Math.random()*98)+'vw';
            s.style.top  = (Math.random()*98)+'vh';
            s.style.fontSize = (1.5+Math.random()*2.5)+'rem';
            s.style.animationDelay    = (Math.random()*10)+'s';
            s.style.animationDuration = (12+Math.random()*10)+'s';
            bg.appendChild(s);
        }
    }

    function getLunesActual() {
        const h = new Date(), l = new Date(h);
        l.setDate(h.getDate()-(h.getDay()||7)+1);
        l.setHours(0,0,0,0); return l;
    }

    function actualizarTimeline() {
        const start = new Date(2026,0,12).getTime();
        const end   = new Date(2026,2,11).getTime();
        const pct   = Math.min(Math.max(((Date.now()-start)/(end-start))*100,0),100);
        document.getElementById('progressBar').style.width = pct+'%';
        document.getElementById('progressPercent').innerText = `${Math.round(pct)}% del reto cumplido`;
    }

    function setFallos(val) {
        const meta = participantes[currentUser] || 1;
        val = Math.round(val*2)/2;
        val = Math.max(0, Math.min(meta, val));
        currentFallos = val;
        document.getElementById('inputFallos').value = val;
        document.getElementById('fallosDisplay').innerText = val;
        document.getElementById('multaPreview').innerHTML = `<strong>$${((30/meta)*val).toFixed(2)}</strong>`;
    }

    function cambiarFallos(delta) { setFallos(currentFallos + delta); }

    function init() {
        buildBg();
        actualizarTimeline();

        document.getElementById('userPicker').innerHTML =
            Object.keys(participantes).sort().map(n =>
                `<button class="user-btn" onclick="login('${n}')">${n}<i class="fa-solid fa-chevron-right" style="color:var(--green); font-size:10px;"></i></button>`
            ).join('');

        const lunes = getLunesActual();
        document.getElementById('semanaSelector').innerHTML = semanas.map(s => {
            const bloq = s.inicio.getTime() >= lunes.getTime();
            return `<option value="${s.id}" ${bloq?'disabled':''}>${s.label} (${s.inicio.getDate()}/${s.inicio.getMonth()+1})${bloq?' üîí':''}</option>`;
        }).join('');

        const terminadas = semanas.filter(s => s.inicio.getTime() < lunes.getTime());
        if(terminadas.length) document.getElementById('semanaSelector').value = terminadas[terminadas.length-1].id;
    }

    async function login(nombre) {
        currentUser = nombre;
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('userNameDisplay').innerText = nombre;
        document.getElementById('metaLabel').innerText = `(m√°x. ${participantes[nombre]})`;
        await cargarReporteSemanal();
        await cargarDatosGlobales();
    }

    async function cargarReporteSemanal() {
        const semId = document.getElementById('semanaSelector').value;
        const { data } = await client.from('registros_asado').select('deuda').eq('nombre',currentUser).eq('semana_id',semId).maybeSingle();
        const meta = participantes[currentUser]||1;
        setFallos(data ? Math.round((data.deuda*meta)/30*2)/2 : 0);
        const semObj = semanas.find(s=>s.id===semId);
        document.getElementById('btnGuardar').disabled = !!(semObj && semObj.inicio.getTime() >= getLunesActual().getTime());
    }

    async function enviarReporte() {
        const btn   = document.getElementById('btnGuardar');
        const semId = document.getElementById('semanaSelector').value;
        const meta  = participantes[currentUser]||1;
        const semObj = semanas.find(s=>s.id===semId);
        if(semObj && semObj.inicio.getTime() >= getLunesActual().getTime()) { alert('Solo puedes reportar semanas ya terminadas.'); return; }
        const deuda = (30/meta)*currentFallos;
        btn.innerText='ESPERA...'; btn.disabled=true;
        const {error} = await client.from('registros_asado').upsert({nombre:currentUser,semana_id:semId,deuda},{onConflict:'nombre,semana_id'});
        if(error){ alert('Error: '+error.message); console.error(error); }
        else await cargarDatosGlobales();
        btn.innerText='GUARDAR'; btn.disabled=false;
    }

    async function cargarDatosGlobales() {
        const {data,error} = await client.from('registros_asado').select('*');
        if(error){ console.error(error.message); return; }
        const lunes = getLunesActual();
        let totales={}, fallosTotales={}, globalPozo=0;
        data?.forEach(r=>{
            totales[r.nombre]=(totales[r.nombre]||0)+r.deuda;
            globalPozo+=r.deuda;
            const meta=participantes[r.nombre]||1;
            fallosTotales[r.nombre]=(fallosTotales[r.nombre]||0)+Math.round((r.deuda*meta)/30*2)/2;
        });

        document.getElementById('totalPozo').innerText=`$${globalPozo.toFixed(2)}`;

        const pajero=Object.keys(totales).sort((a,b)=>totales[b]-totales[a])[0];
        if(pajero && totales[pajero]>0){
            document.getElementById('pajeroNombre').innerText=pajero;
            const pct=globalPozo>0?((totales[pajero]/globalPozo)*100).toFixed(1):0;
            document.getElementById('pajeroPct').innerText=`Ha pagado $${totales[pajero].toFixed(2)} ‚Äî el ${pct}% del pozo`;
            document.getElementById('pajeroBox').style.display='block';
        } else { document.getElementById('pajeroBox').style.display='none'; }

        document.getElementById('semanasHeader').innerHTML = semanas.map(s=>
            `<div style="width:11px;font-size:7px;font-weight:900;color:#94a3b8;text-align:center;flex-shrink:0;">${s.label}</div>`
        ).join('');

        const ranking=Object.keys(participantes).sort((a,b)=>(totales[b]||0)-(totales[a]||0));
        document.getElementById('rankingRows').innerHTML=ranking.map((n,idx)=>{
            const dots=semanas.map(s=>{
                const reg=data?.find(r=>r.nombre===n&&r.semana_id===s.id);
                const pasada=s.inicio.getTime()<lunes.getTime();
                let cls='dot-futuro';
                if(reg) cls=reg.deuda===0?'dot-ok':'dot-fallo';
                else if(pasada) cls='dot-debe';
                return `<div class="week-dot ${cls}" title="${s.label}"></div>`;
            }).join('');
            const esYo=n===currentUser;
            const meta=participantes[n]||0;
            const fallos=fallosTotales[n]||0;
            return `
            <div class="rank-row ${esYo?'me':''}">
                <div class="rank-num">${idx+1}</div>
                <div class="rank-name" style="color:${esYo?'var(--darkgreen)':'var(--text)'};">${n}</div>
                <div class="rank-meta">${meta}x</div>
                <div class="rank-dots">${dots}</div>
                <div class="rank-fallos" style="color:${fallos>0?'var(--red)':'var(--green)'};">${fallos}</div>
                <div class="rank-monto">$${(totales[n]||0).toFixed(2)}</div>
            </div>`;
        }).join('');
    }

    init();
</script>
</body>
</html>
