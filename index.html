<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UV Running - Pozo Real</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Archivo+Black&family=Inter:wght@400;600;800&display=swap');
        body { background: linear-gradient(135deg, #e0f2fe 0%, #f0fdf4 100%); color: #1e293b; font-family: 'Inter', sans-serif; min-height: 100vh; }
        .font-sport { font-family: 'Archivo Black', sans-serif; text-transform: uppercase; letter-spacing: -1px; }
        .card-white { background: white; border-radius: 24px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
        .btn-sport { background: #10b981; color: white; transition: all 0.2s; cursor: pointer; }
        .btn-sport:disabled { background: #cbd5e1; cursor: not-allowed; }
    </style>
</head>
<body class="p-4 pb-12">

    <div id="loginScreen" class="max-w-md mx-auto mt-10">
        <div class="text-center mb-8">
            <i class="fa-solid fa-person-running text-5xl text-emerald-500 mb-4"></i>
            <h1 class="text-4xl font-sport bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-emerald-500 text-center">UV RUNNING</h1>
            <p class="text-slate-400 font-bold text-[10px] tracking-widest mt-2 uppercase text-center italic">Selecciona tu perfil para entrar</p>
        </div>
        <div class="card-white p-6 shadow-xl">
            <div class="grid grid-cols-1 gap-2 max-h-[50vh] overflow-y-auto pr-2" id="userPicker"></div>
        </div>
    </div>

    <div id="mainApp" class="hidden max-w-md mx-auto">
        <header class="flex justify-between items-center py-4 px-2">
            <span class="font-sport text-emerald-600 italic tracking-tighter text-sm italic underline decoration-emerald-300"> <i class="fa-solid fa-medal"></i> Dashboard Global</span>
            <button onclick="location.reload()" class="text-[9px] font-black text-slate-400 uppercase bg-white px-3 py-1 rounded-full shadow-sm"> <i class="fa-solid fa-arrow-left"></i> Salir</button>
        </header>

        <div class="card-white p-8 mb-6 text-center border-b-8 border-emerald-500 relative">
            <h2 class="text-[10px] font-black text-slate-400 uppercase mb-1 tracking-[0.2em]">Pozo Acumulado</h2>
            <div id="totalPozo" class="text-6xl font-sport text-slate-800">$0.00</div>
            <p class="text-[9px] text-emerald-500 font-bold mt-2 uppercase tracking-widest">Sincronizado en tiempo real</p>
        </div>

        <div id="alertaPendiente" class="hidden bg-orange-100 border border-orange-200 text-orange-700 p-4 rounded-2xl mb-6 flex items-center gap-3">
            <i class="fa-solid fa-clock-rotate-left text-xl"></i>
            <div>
                <p class="text-xs font-bold uppercase tracking-tight">Reporte Semanal</p>
                <p class="text-[10px]" id="textoSemanaReportar"></p>
            </div>
        </div>

        <div class="card-white p-6 mb-8">
            <div class="flex items-center gap-3 mb-6">
                <div class="bg-blue-100 w-10 h-10 rounded-full flex items-center justify-center text-blue-600"><i class="fa-solid fa-user"></i></div>
                <div>
                    <h3 class="font-extrabold text-slate-800 leading-none" id="userNameDisplay"></h3>
                    <p id="userMetaDisplay" class="text-[9px] font-black text-blue-500 uppercase mt-1"></p>
                </div>
            </div>
            
            <div class="bg-slate-50 rounded-2xl p-4 border border-slate-100">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-3 text-center tracking-widest">¿Cuántas veces fallaste?</p>
                <div class="flex gap-2">
                    <input type="number" id="inputFallos" class="w-20 bg-white border-2 border-slate-100 rounded-xl p-2 text-center font-bold text-xl outline-none" value="0" min="0">
                    <button id="btnReportar" onclick="enviarASupabase()" class="btn-sport flex-1 rounded-xl font-black text-xs uppercase shadow-sm">Confirmar</button>
                </div>
            </div>
        </div>

        <div class="flex justify-between items-center mb-3 px-2">
            <h3 class="font-sport text-slate-400 text-[10px] tracking-widest"> <i class="fa-solid fa-list-ol mr-1"></i> Aportes del Grupo</h3>
            <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest italic">Acumulado</span>
        </div>
        <div id="rankingList" class="space-y-2"></div>
    </div>

    <script>
        // --- CONFIGURACIÓN SUPABASE ---
        // REEMPLAZA ESTO CON TUS DATOS DE SETTINGS > API
        const SUPABASE_URL = 'https://yibllgoulqowzewyusdh.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_dYy4Q9ZjPa-O15MFbmpNvg_Z_1lSomQ';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const metasMapping = { "Mati Adauy": 7, "Pablo Torné": 6, "Joaquín Leonart": 5, "Sami Arteaga": 5, "Pedro De la Barra": 5, "Seba Ábalos": 5, "Tomás Balbontín": 4, "Roque Santa Cruz": 4, "Rodrigo Ábalos": 4, "León Lehman": 4, "Eugenio Cox": 4, "Feña Covarrubias": 4, "Seba Domeyko": 3, "Lucas Perez": 3, "Martín González": 3, "Martín Muñoz": 3, "Ignacio Eyzaguirre": 3, "Pablo Bas": 3, "Nacho Achondo": 3, "Tatan Ruiza": 3, "Toto Labán": 3 };
        
        let currentUser = null;

        function getSemanaId() {
            let d = new Date(); d.setDate(d.getDate() - (d.getDay() || 7) - 6);
            return `sem-${d.getDate()}-${d.getMonth()+1}-${d.getFullYear()}`;
        }

        async function init() {
            const picker = document.getElementById('userPicker');
            picker.innerHTML = Object.keys(metasMapping).map(n => `
                <button onclick="login('${n}')" class="w-full text-left p-3 mb-2 bg-slate-50 hover:bg-emerald-50 rounded-xl font-bold text-sm border flex justify-between items-center">
                    ${n} <span class="text-[10px] text-slate-400 uppercase italic">META: ${metasMapping[n]}</span>
                </button>
            `).join('');
        }

        async function login(nombre) {
            currentUser = nombre;
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userNameDisplay').innerText = nombre;
            document.getElementById('userMetaDisplay').innerText = `Tu objetivo: ${metasMapping[nombre]} entrenamientos`;
            document.getElementById('textoSemanaReportar').innerText = `Es momento de reportar tus fallos de la semana pasada.`;
            
            verificarReporteExistente();
            cargarDatosGlobales();
        }

        async function verificarReporteExistente() {
            const { data } = await supabaseClient.from('registros_asado').select('*').eq('nombre', currentUser).eq('semana_id', getSemanaId());
            if (data && data.length > 0) {
                document.getElementById('btnReportar').disabled = true;
                document.getElementById('btnReportar').innerText = "REPORTADO ✓";
                document.getElementById('alertaPendiente').classList.add('hidden');
            } else {
                document.getElementById('alertaPendiente').classList.remove('hidden');
            }
        }

        async function enviarASupabase() {
            const fallos = parseInt(document.getElementById('inputFallos').value);
            if (fallos > metasMapping[currentUser]) return alert("No puedes tener más fallos que tu meta.");
            
            const deuda = (30 / metasMapping[currentUser]) * fallos;
            const { error } = await supabaseClient.from('registros_asado').insert([{ nombre: currentUser, deuda: deuda, semana_id: getSemanaId() }]);

            if (!error) { alert("¡Reporte guardado!"); location.reload(); }
            else { alert("Error: " + error.message); }
        }

        async function cargarDatosGlobales() {
            const { data } = await supabaseClient.from('registros_asado').select('nombre, deuda');
            let totales = {}, global = 0;
            data?.forEach(r => { totales[r.nombre] = (totales[r.nombre] || 0) + r.deuda; global += r.deuda; });

            document.getElementById('totalPozo').innerText = `$${global.toFixed(2)}`;
            const list = document.getElementById('rankingList');
            list.innerHTML = Object.keys(metasMapping).sort((a,b) => (totales[b]||0) - (totales[a]||0)).map((n, i) => `
                <div class="card-white p-3 flex justify-between items-center ${n === currentUser ? 'border-2 border-emerald-500 shadow-md' : 'opacity-90'}">
                    <span class="text-xs font-bold text-slate-600">#${i+1} ${n}</span>
                    <span class="font-sport text-sm ${totales[n] > 0 ? 'text-red-500' : 'text-slate-200'}">$${(totales[n] || 0).toFixed(2)}</span>
                </div>
            `).join('');
        }
        init();
    </script>
</body>
</html>
