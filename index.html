<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UV Running - Master Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Archivo+Black&family=Inter:wght@400;600;800&display=swap');
        body { background: #f8fafc; color: #1e293b; font-family: 'Inter', sans-serif; }
        .font-sport { font-family: 'Archivo Black', sans-serif; text-transform: uppercase; }
        .card { background: white; border-radius: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .progress-glow { box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
    </style>
</head>
<body class="p-4 max-w-lg mx-auto pb-20">

    <div id="loginScreen" class="mt-10 text-center">
        <h1 class="text-4xl font-sport text-emerald-600 mb-8">UV RUNNING</h1>
        <div class="card p-6">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Selecciona tu Perfil</p>
            <div id="userPicker" class="grid grid-cols-1 gap-2 max-h-96 overflow-y-auto"></div>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <header class="flex justify-between items-center py-4">
            <span class="font-sport text-emerald-600 italic">Challenge 2026</span>
            <button onclick="location.reload()" class="text-[10px] font-bold text-slate-400 uppercase">Salir</button>
        </header>

        <div class="card p-5 mb-6">
            <div class="flex justify-between text-[10px] font-bold text-slate-400 mb-2 uppercase">
                <span>Inicio: 12 Ene</span>
                <span>Asado: 13 Mar</span>
            </div>
            <div class="w-full bg-slate-100 h-4 rounded-full overflow-hidden flex items-center p-1">
                <div id="progressBar" class="h-2 bg-emerald-500 rounded-full transition-all duration-1000 progress-glow" style="width: 0%"></div>
            </div>
            <p id="progressText" class="text-center text-[10px] font-bold text-emerald-600 mt-2 uppercase"></p>
        </div>

        <div class="card p-6 mb-6 text-center border-b-4 border-emerald-500">
            <h2 class="text-[10px] font-black text-slate-400 uppercase">Pozo Acumulado</h2>
            <div id="totalPozo" class="text-5xl font-sport text-slate-800">$0.00</div>
        </div>

        <div class="card p-6 mb-6">
            <h3 class="font-bold text-slate-800 mb-4 flex justify-between">
                <span>Hola, <span id="userNameDisplay"></span></span>
                <span id="userMetaTag" class="text-[9px] bg-blue-100 text-blue-600 px-2 py-1 rounded"></span>
            </h3>
            
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase">Semana a reportar/editar:</label>
                    <select id="semanaSelector" class="w-full p-2 bg-slate-50 border rounded-lg text-sm font-bold mt-1" onchange="cargarReporteSemanal()"></select>
                </div>
                <div class="flex gap-4 items-end">
                    <div class="flex-1">
                        <label class="text-[10px] font-black text-slate-400 uppercase">Fallos:</label>
                        <input type="number" id="inputFallos" class="w-full p-2 bg-white border rounded-lg font-bold text-center" value="0" min="0">
                    </div>
                    <button onclick="enviarReporte()" class="bg-emerald-500 text-white px-6 py-2.5 rounded-lg font-bold text-xs uppercase shadow-lg active:scale-95 transition">Guardar</button>
                </div>
            </div>
        </div>

        <h3 class="font-sport text-slate-400 text-[10px] mb-3 ml-2 uppercase">Estado de Participantes</h3>
        <div id="rankingList" class="space-y-2"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://yibllgoulqowzewyusdh.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_dYy4Q9ZjPa-015MFbmpNvg_Z_1lSwa6a8b16e4564c70d4f3b0656a9926861218868612';
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const participantes = { "Mati Adauy": 7, "Pablo Torné": 6, "Joaquín Leonart": 5, "Sami Arteaga": 5, "Pedro De la Barra": 5, "Seba Ábalos": 5, "Tomás Balbontín": 4, "Roque Santa Cruz": 4, "Rodrigo Ábalos": 4, "León Lehman": 4, "Eugenio Cox": 4, "Feña Covarrubias": 4, "Seba Domeyko": 3, "Lucas Perez": 3, "Martín González": 3, "Martín Muñoz": 3, "Ignacio Eyzaguirre": 3, "Pablo Bas": 3, "Nacho Achondo": 3, "Tatan Ruiza": 3, "Toto Labán": 3 };
        
        let currentUser = null;

        function generarSemanas() {
            const lista = [];
            let fecha = new Date(2026, 0, 12); // 12 de enero 2026
            const finChallenge = new Date(2026, 2, 8); // 8 de marzo 2026

            while (fecha <= finChallenge) {
                let inicio = new Date(fecha);
                let fin = new Date(fecha);
                fin.setDate(fin.getDate() + 6);
                
                const label = `${inicio.getDate()}/${inicio.getMonth()+1} - ${fin.getDate()}/${fin.getMonth()+1}`;
                const id = `sem-${inicio.getDate()}-${inicio.getMonth()+1}`;
                lista.push({ id, label, inicio: new Date(inicio) });
                
                fecha.setDate(fecha.getDate() + 7);
            }
            return lista;
        }

        function actualizarTimeline() {
            const inicio = new Date(2026, 0, 12).getTime();
            const asado = new Date(2026, 2, 13).getTime();
            const hoy = new Date().getTime();
            
            const total = asado - inicio;
            const transcurrido = hoy - inicio;
            let porcentaje = (transcurrido / total) * 100;
            porcentaje = Math.min(Math.max(porcentaje, 0), 100);

            document.getElementById('progressBar').style.width = porcentaje + '%';
            document.getElementById('progressText').innerText = `Vas al ${Math.round(porcentaje)}% del camino al asado`;
        }

        async function init() {
            actualizarTimeline();
            const picker = document.getElementById('userPicker');
            picker.innerHTML = Object.keys(participantes).map(n => `
                <button onclick="login('${n}')" class="w-full text-left p-3 bg-slate-50 hover:bg-emerald-50 rounded-xl font-bold text-sm border transition">${n}</button>
            `).join('');

            const selector = document.getElementById('semanaSelector');
            const semanas = generarSemanas();
            selector.innerHTML = semanas.map(s => `<option value="${s.id}">${s.label}</option>`).join('');
            // Por defecto seleccionar semana anterior
        }

        async function login(nombre) {
            currentUser = nombre;
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userNameDisplay').innerText = nombre;
            document.getElementById('userMetaTag').innerText = `Meta: ${participantes[nombre]}`;
            cargarReporteSemanal();
            cargarDatosGlobales();
        }

        async function cargarReporteSemanal() {
            const semId = document.getElementById('semanaSelector').value;
            const { data } = await client.from('registros_asado').select('deuda').eq('nombre', currentUser).eq('semana_id', semId).single();
            
            if (data) {
                const meta = participantes[currentUser];
                const fallosOriginales = (data.deuda * meta) / 30;
                document.getElementById('inputFallos').value = Math.round(fallosOriginales);
            } else {
                document.getElementById('inputFallos').value = 0;
            }
        }

        async function enviarReporte() {
            const semId = document.getElementById('semanaSelector').value;
            const fallos = parseInt(document.getElementById('inputFallos').value);
            const deuda = (30 / participantes[currentUser]) * fallos;

            // Upsert: si existe lo edita, si no, lo crea
            const { error } = await client.from('registros_asado').upsert({ 
                nombre: currentUser, 
                semana_id: semId, 
                deuda: deuda 
            }, { onConflict: 'nombre,semana_id' });

            if (!error) {
                alert("Reporte actualizado correctamente");
                cargarDatosGlobales();
            }
        }

        async function cargarDatosGlobales() {
            const { data } = await client.from('registros_asado').select('*');
            const semanas = generarSemanas();
            
            // Lógica para saber cuál es la "semana pasada"
            const hoy = new Date();
            const lunesActual = new Date(hoy);
            lunesActual.setDate(hoy.getDate() - (hoy.getDay() || 7) + 1);
            
            const semAnterior = semanas.filter(s => s.inicio < lunesActual).reverse()[0];
            const esMartesOMas = hoy.getDay() >= 2 || hoy.getDay() === 0;

            let totales = {}, global = 0, reportesSemAnterior = new Set();
            
            data?.forEach(r => {
                totales[r.nombre] = (totales[r.nombre] || 0) + r.deuda;
                global += r.deuda;
                if (semAnterior && r.semana_id === semAnterior.id) reportesSemAnterior.add(r.nombre);
            });

            document.getElementById('totalPozo').innerText = `$${global.toFixed(2)}`;
            const list = document.getElementById('rankingList');
            
            const ranking = Object.keys(participantes).sort((a,b) => (totales[b]||0) - (totales[a]||0));

            list.innerHTML = ranking.map((n, i) => {
                const aportado = totales[n] || 0;
                const alDia = reportesSemAnterior.has(n);
                const colorSemaf = (!esMartesOMas || alDia) ? 'bg-emerald-500' : 'bg-red-500';

                return `
                    <div class="card p-3 flex justify-between items-center ${n === currentUser ? 'ring-2 ring-emerald-500' : ''}">
                        <div class="flex items-center gap-3">
                            <div class="w-2 h-2 rounded-full ${colorSemaf}"></div>
                            <span class="text-xs font-bold text-slate-700">${n}</span>
                        </div>
                        <span class="font-sport text-sm text-slate-800">$${aportado.toFixed(2)}</span>
                    </div>
                `;
            }).join('');
        }

        init();
    </script>
</body>
</html>
